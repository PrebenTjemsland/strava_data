name: Deploy Strava App

on:
    push:
        branches:
            - main

permissions:
    contents: read

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            RELEASE_DIR: /tmp/strava_data_release_${{ github.run_id }}_${{ github.run_attempt }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install Frontend Dependencies
              run: npm install

            - name: Build Frontend
              env:
                  # Configure deployment path and API host from GitHub Variables.
                  # Example:
                  # - VITE_BASE_PATH=/strava-data/
                  # - VITE_API_BASE_URL=https://penten.duckdns.org
                  # Default deploy path for this app.
                  VITE_BASE_PATH: ${{ vars.VITE_BASE_PATH || '/strava-data/' }}
                  VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL || 'https://penten.duckdns.org' }}
              run: npm run build

            - name: Upload Release Bundle
              uses: appleboy/scp-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  source: 'dist/,strava-backend/'
                  target: '${{ env.RELEASE_DIR }}/'

            - name: Deploy on Server
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                      set -euo pipefail
                      RELEASE_ROOT='${{ env.RELEASE_DIR }}'
                      BACKEND_DIR='/tmp/strava_backend_${{ github.run_id }}_${{ github.run_attempt }}'

                      RELEASE_DIR="$RELEASE_ROOT"
                      if [ ! -f "$RELEASE_DIR/dist/index.html" ] || [ ! -f "$RELEASE_DIR/strava-backend/index.js" ]; then
                        MATCH="$(find "$RELEASE_ROOT" -maxdepth 5 -type f -path '*/dist/index.html' | head -n 1 || true)"
                        if [ -z "$MATCH" ]; then
                          echo "Could not locate dist/index.html under $RELEASE_ROOT"
                          find "$RELEASE_ROOT" -maxdepth 5 -print || true
                          exit 1
                        fi
                        RELEASE_DIR="$(dirname "$(dirname "$MATCH")")"
                      fi
                      test -f "$RELEASE_DIR/dist/index.html"
                      test -f "$RELEASE_DIR/strava-backend/index.js"
                      test -f "$RELEASE_DIR/strava-backend/package-lock.json"

                      # Frontend publish directly into NPM container web root.
                      docker exec nginx-proxy-manager sh -lc 'rm -rf /data/frontend/*'
                      docker cp "$RELEASE_DIR/dist/." nginx-proxy-manager:/data/frontend/

                      # Stage backend into a stable host path before container start.
                      rm -rf "$BACKEND_DIR" || true
                      mkdir -p "$BACKEND_DIR"
                      cp -a "$RELEASE_DIR/strava-backend/." "$BACKEND_DIR/"

                      # Backend runs on same Docker network as NPM.
                      docker pull node:20-alpine
                      docker rm -f strava-backend-api >/dev/null 2>&1 || true
                      docker run -d \
                        --name strava-backend-api \
                        --restart unless-stopped \
                        --network homelab-net \
                        --user $(id -u):$(id -g) \
                        -e HOME=/tmp \
                        -v "$BACKEND_DIR:/app" \
                        -v /var/www/mywebapp/strava-backend/.env:/app/.env:ro \
                        -w /app \
                        node:20-alpine \
                        sh -lc 'npm ci --omit=dev && set -a; . /app/.env; set +a; node index.js'

                      docker ps --filter name=strava-backend-api --format 'table {{.Names}}\t{{.Status}}\t{{.Networks}}'
                      rm -rf "$RELEASE_DIR" || true
