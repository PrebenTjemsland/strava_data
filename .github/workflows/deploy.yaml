name: Deploy Strava App

on:
    push:
        branches:
            - main

permissions:
    contents: read

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install Frontend Dependencies
              run: npm install

            - name: Build Frontend
              env:
                  # Configure deployment path and API host from GitHub Variables.
                  # Example:
                  # - VITE_BASE_PATH=/strava-data/
                  # - VITE_API_BASE_URL=https://penten.duckdns.org
                  # Default deploy path for this app.
                  VITE_BASE_PATH: ${{ vars.VITE_BASE_PATH || '/strava-data/' }}
                  VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL || 'https://penten.duckdns.org' }}
              run: npm run build

            - name: Deploy to Server
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                      set -e # Exit immediately if a command exits with a non-zero status.
                      cd /var/www/mywebapp
                      # Frontend deploy step writes into dist/, so keep pulls resilient to local changes.
                      git pull --rebase --autostash origin main

                      # Run backend on the same Docker network as NPM to avoid host-port routing issues.
                      docker pull node:20-alpine
                      docker rm -f strava-backend-api >/dev/null 2>&1 || true
                      docker run -d \
                        --name strava-backend-api \
                        --restart unless-stopped \
                        --network homelab-net \
                        -v /var/www/mywebapp/strava-backend:/app \
                        -w /app \
                        node:20-alpine \
                        sh -lc 'set -a; . /app/.env; set +a; node index.js'
                      docker ps --filter name=strava-backend-api --format 'table {{.Names}}\t{{.Status}}\t{{.Networks}}'
            - name: Deploy Frontend via SCP
              uses: appleboy/scp-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  # Copy the dist folder into /var/www/mywebapp so the host mount
                  # /var/www/mywebapp/dist -> /data/frontend stays populated.
                  source: 'dist/'
                  target: '/var/www/mywebapp/'
