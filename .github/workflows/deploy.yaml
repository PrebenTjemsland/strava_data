name: Deploy Strava App

on:
    push:
        branches:
            - main

permissions:
    contents: read

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install Frontend Dependencies
              run: npm install

            - name: Build Frontend
              env:
                  # Configure deployment path and API host from GitHub Variables.
                  # Example:
                  # - VITE_BASE_PATH=/strava-data/
                  # - VITE_API_BASE_URL=https://penten.duckdns.org
                  # Default deploy path for this app.
                  VITE_BASE_PATH: ${{ vars.VITE_BASE_PATH || '/strava-data/' }}
                  VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL || 'https://penten.duckdns.org' }}
              run: npm run build

            - name: Upload Release Bundle
              uses: appleboy/scp-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  source: 'dist/,strava-backend/'
                  target: '/tmp/strava_data_release/'

            - name: Deploy on Server
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                      set -e
                      RELEASE_DIR=/tmp/strava_data_release

                      test -f "$RELEASE_DIR/dist/index.html"
                      test -f "$RELEASE_DIR/strava-backend/index.js"

                      # Frontend publish directly into NPM container web root.
                      docker exec nginx-proxy-manager sh -lc 'rm -rf /data/frontend/*'
                      docker cp "$RELEASE_DIR/dist/." nginx-proxy-manager:/data/frontend/

                      # Backend runs on same Docker network as NPM.
                      docker pull node:20-alpine
                      docker rm -f strava-backend-api >/dev/null 2>&1 || true
                      docker run -d \
                        --name strava-backend-api \
                        --restart unless-stopped \
                        --network homelab-net \
                        -v "$RELEASE_DIR/strava-backend:/app" \
                        -v /var/www/mywebapp/strava-backend/.env:/app/.env:ro \
                        -w /app \
                        node:20-alpine \
                        sh -lc 'npm ci --omit=dev && set -a; . /app/.env; set +a; node index.js'

                      docker ps --filter name=strava-backend-api --format 'table {{.Names}}\t{{.Status}}\t{{.Networks}}'
